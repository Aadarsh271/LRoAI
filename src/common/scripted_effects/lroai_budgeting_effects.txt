#
# tag           : tag_aroai_check_if_military_expenses_are_higher_than_usual
# Called by     : aroai_preparation_events.1
# If army or navy are currently used in diplomatic play, their expenses will be higher than usual. Many actions are
# affected by this or by country being at war in general. To improve stability of country management a timed variable
# is used. When war ends, decision making returns to peaceful mode not in the next iteration, but in the next + 1.
#
lroai_check_if_military_expenses_are_higher_than_usual = {
    if = {
        limit = {
            lroai_is_using_military_forces = yes
        }
        lroai_renew_variable = {
            name = lroai_military_expenses_are_higher_than_usual
            days = lroai_days_in_the_iteration_plus_week
        }
    }
}


#
# tag           : tag_aroai_manage_tax_and_wage_level
# Called by     : aroai_preparation_events.1
#
# Custom management of budget settings
#
aroai_manage_tax_and_wage_level = {

    # If the country is a player, don't do anything
    if = {
        limit = { is_player = yes  }
        #Do nothing

    }
    # If the country is in debt, set the taxes very high, and the wages very low
    else if {
        limit = { scaled_debt > 0}

        set_tax_level = very_high
        set_military_wage_level = very_low
        set_government_wage_level = very_low
    }
    # If the country is between 0 and 50% of the gold reserves limit, set the taxes high, and the wages low
    else if {
        limit = { lroai_gold_reserves_percent > 0 lroai_gold_reserves_percent < 0.5}

        set_tax_level = high
        set_military_wage_level = low
        set_government_wage_level = low
    }
    # If the country have more than 50% of the gold reserves limit, set the taxes and the wages medium
    else {
        set_tax_level = medium
        set_military_wage_level = medium
        set_government_wage_level = medium
    }
}


# Custom management of budget settings
lroai_manage_tax_and_wage_level_old = {
    if = {
        limit = {
            has_variable = lroai_country_budget_surplus
            is_player = no
            NOT = {
                has_variable = lroai_budget_settings_cooldown
            }
        }
        
        # Budget is neutral or positive: lower taxes and raise wages.
        # Priorities:
        # 1. Ensure tax level is not very high.
        # 2. Ensure wage level is not below medium.
        # 3. Gradually lower tax level to low.
        # 4. Gradually raise wages to very high.
        # 5. Lower taxt level to very low.
        if = {
            limit = {
                lroai_budget_health_is_equal_or_higher = {
                    level = 0
                }

                # Don't do it if construction expenses are far smaller than planned
                # TODO this doesn't work cause sector spending need later data
                # lroai_building_construction_sector_spending_value >= lroai_building_construction_sector_spending_1
            }
            
            # Raise wages.
            # If taxes are on very high level, then lowering taxes is the priority so we skip this.
            if = {
                limit = {
                    lroai_tax_level_equal_or_lower = {
                        value = 4
                    }
                }

                # Government wages
                if = {
                    limit = {
                        lroai_government_wages_are_very_low = yes
                    }
                    set_government_wage_level = low
                    set_local_variable = lroai_budget_settings_cooldown
                }
                else_if = {
                    limit = {
                        lroai_government_wages_are_low = yes
                    }
                    set_government_wage_level = medium
                    set_local_variable = lroai_budget_settings_cooldown
                }
                else_if = {
                    limit = {
                        lroai_budget_health_is_equal_or_higher = {
                            level = 1
                        }
                        lroai_tax_level_equal_or_lower = {
                            value = 2
                        }
                    }
                    if = {
                        limit = {
                            lroai_government_wages_are_medium = yes
                        }
                        set_government_wage_level = high
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                    else_if = {
                        limit = {
                            lroai_government_wages_are_high = yes
                        }
                        set_government_wage_level = very_high
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                }

                # Military wages
                if = {
                    limit = {
                        lroai_military_wages_are_very_low = yes
                    }
                    set_military_wage_level = low
                    set_local_variable = lroai_budget_settings_cooldown
                }
                else_if = {
                    limit = {
                        lroai_military_wages_are_low = yes
                    }
                    set_military_wage_level = medium
                    set_local_variable = lroai_budget_settings_cooldown
                }
                else_if = {
                    limit = {
                        lroai_budget_health_is_equal_or_higher = {
                            level = 1
                        }
                        lroai_tax_level_equal_or_lower = {
                            value = 2
                        }
                    }
                    if = {
                        limit = {
                            lroai_military_wages_are_medium = yes
                        }
                        set_military_wage_level = high
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                    else_if = {
                        limit = {
                            lroai_military_wages_are_high = yes
                        }
                        set_military_wage_level = very_high
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                }
            }
            
            # Lower taxes.
            # If wages were raised, skip this as we don't wanna change too much.
            if = {
                limit = {
                    NOT = {
                        has_local_variable = lroai_budget_settings_cooldown
                    }
                }
                if = {
                    limit = {
                        tax_level = very_high
                    }
                    set_tax_level = high
                    set_local_variable = lroai_budget_settings_cooldown
                }
                else_if = {
                    limit = {
                        lroai_budget_health_is_equal_or_higher = {
                            level = 2
                        }
                    }
                    if = {
                        limit = {
                            tax_level = high
                        }
                        set_tax_level = medium
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                    else_if = {
                        limit = {
                            tax_level = medium
                        }
                        set_tax_level = low
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                    else_if = {
                        limit = {
                            tax_level = low
                            lroai_government_wages_are_very_high = yes
                            lroai_military_wages_are_very_high = yes
                        }
                        set_tax_level = very_low
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                }
            }
        }
        
        # Budget is below neutral: raise taxes and lower wages.
        # Priorities:
        # 1. Ensure tax level is not very low.
        # 2. Ensure wage level is not above medium.
        # 3. Gradually raise tax level to high.
        # 4. Gradually lower wage level to very low.
        # Sidenotes:
        # – Military wages are always set to medium during wars.
        # – Wages may be raised from very low to low if the situation is not that bad.
        else_if = {
            limit = {
                NOT = {
                    lroai_budget_health_is_equal_or_higher = {
                        level = 0
                    }
                }
            }
            
            # Raise taxes
            if = {
                limit = {
                    tax_level = very_low
                }
                set_tax_level = low
                set_local_variable = lroai_budget_settings_cooldown
            }
            
            # Lower wages
            else_if = {
                limit = {
                    OR = {
                        lroai_government_wages_are_very_high = yes
                        lroai_military_wages_are_very_high = yes
                    }
                }
                set_government_wage_level = high
                set_military_wage_level = high
                set_local_variable = lroai_budget_settings_cooldown
            }
            else_if = {
                limit = {
                    OR = {
                        lroai_government_wages_are_high = yes
                        lroai_military_wages_are_high = yes
                    }
                }
                set_government_wage_level = medium
                set_military_wage_level = medium
                set_local_variable = lroai_budget_settings_cooldown
            }
            else = {
                
                # Raise wages is they are very low but budget health is not that bad
                if = {
                    limit = {
                        lroai_budget_health_is_equal_or_higher = {
                            level = -2
                        }
                        lroai_tax_level_equal_or_higher = {
                            value = 4
                        }
                    }
                    if = {
                        limit = {
                            OR = {
                                lroai_government_wages_are_very_low = yes
                                lroai_can_cut_government_wages = yes
                            }
                        }
                        set_government_wage_level = low
                    }
                    if = {
                        limit = {
                            OR = {
                                lroai_military_wages_are_very_low = yes
                                lroai_can_cut_military_wages = yes
                            }
                        }
                        set_military_wage_level = low
                    }
                }

                # Lower wages
                else_if = {
                    limit = {
                        NOT = {
                            lroai_budget_health_is_equal_or_higher = {
                                level = -2
                            }
                        }
                        lroai_tax_level_equal_or_higher = {
                            value = 4
                        }
                    }
                    if = {
                        limit = {
                            lroai_government_wages_are_low = yes
                            lroai_can_cut_government_wages = yes
                        }
                        set_government_wage_level = very_low
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                    if = {
                        limit = {
                            lroai_military_wages_are_low = yes
                            lroai_can_cut_military_wages = yes
                        }
                        set_military_wage_level = very_low
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                }
                
                # Force military wages when in conflict
                if = {
                    limit = {
                        lroai_is_using_military_forces = yes
                    }
                    set_military_wage_level = medium
                }
                
                # Raise taxes
                if = {
                    limit = {
                        NOT = {
                            has_local_variable = lroai_budget_settings_cooldown
                        }
                    }
                    if = {
                        limit = {
                            lroai_budget_health_is_equal_or_higher = {
                                level = -3
                            }
                            lroai_tax_level_equal_or_lower = {
                                value = 3
                            }
                        }
                        if = {
                            limit = {
                                tax_level = very_low
                            }
                            set_tax_level = low
                            set_local_variable = lroai_budget_settings_cooldown
                        }
                        else_if = {
                            limit = {
                                tax_level = low
                            }
                            set_tax_level = medium
                            set_local_variable = lroai_budget_settings_cooldown
                        }
                        else_if = {
                            limit = {
                                tax_level = medium
                            }
                            set_tax_level = high
                            set_local_variable = lroai_budget_settings_cooldown
                        }
                    }
                    else_if = {
                        limit = {
                            NOT = {
                                lroai_budget_health_is_equal_or_higher = {
                                    level = -3
                                }
                            }
                            lroai_tax_level_equal_or_lower = {
                                value = 4
                            }
                        }
                        set_tax_level = very_high
                        set_local_variable = lroai_budget_settings_cooldown
                    }
                }
            }
        }

        # Local variable into timed variable
        if = {
            limit = {
                has_local_variable = lroai_budget_settings_cooldown
            }
            set_variable = {
                name = lroai_budget_settings_cooldown
                value = yes
                days = lroai_days_in_the_iteration_plus_week
            }
            remove_local_variable = lroai_budget_settings_cooldown
        }
    }
}